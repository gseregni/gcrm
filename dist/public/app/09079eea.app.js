"use strict";angular.module("galimbertiCrmApp",["ngCookies","ngResource","ngSanitize","ui.router","ui.bootstrap","angularjs-dropdown-multiselect","LocalStorageModule"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","localStorageServiceProvider",function(a,b,c,d){d.setPrefix("gcrm"),b.otherwise("/"),c.html5Mode(!0)}]);var clientId="246770070242-61imh7fej22jkonn8a58ppssbq7391b2.apps.googleusercontent.com",apiKey="AIzaSyC9vVAApxr8-ury3bK2Y3NYIADMb5QykXs",scopes="https://www.googleapis.com/auth/drive",init=function(){gapi.client.setApiKey(apiKey),gapi.client.load("drive","v2"),console.log("gapi loaded")};angular.module("galimbertiCrmApp").controller("MainCtrl",["$rootScope","$scope","$http","$q","$timeout","$interval","localStorageService","HighRiseDeal","HighRisePeople","HighRiseDealCategory",function(a,b,c,d,e,f,g,h,i,j){function k(){gapi.auth.authorize({client_id:r,scope:t,immediate:!0},l)}function l(a){var c=document.getElementById("authorize-button");a&&!a.error?(q=a.access_token,c.style.visibility="hidden",w(),b.$apply(function(){b.gdriveLoggedin=!0})):(c.style.visibility="",c.onclick=m)}function m(a){return gapi.auth.authorize({client_id:r,scope:t,immediate:!1},l),!1}function n(a,b,c,f){var g=(d.defer(),gapi.client.request({path:"/drive/v2/files",method:"GET",params:{maxResults:"100",q:"'"+a+"' in parents"}}));return g.then(function(a){var g=a.result;return g.items?d.all(g.items.map(function(a){"application/vnd.google-apps.folder"===a.mimeType?e(function(){var d={title:a.title,fileId:a.id,mimeType:a.mimeType,items:[]};return b.items.push(d),x(c,f?f:a.title,a.id,d)},200):e(function(){b.items.push({title:a.title,fileId:a.id,mimeType:a.mimeType});var d={title:a.title,parents:[{id:c}]},e=gapi.client.drive.files.copy({fileId:a.id,resource:d});e.execute(function(a){console.log("Copy ID: "+a.id)})},200)})):void 0})}b.hrtokenIta=g.get("hrtokenIta"),b.hrtokenSwi=g.get("hrtokenSwi");var o="https://swissgalimbertisa.highrisehq.com/deals",p="https://galimbertisrl1.highrisehq.com/deals";b.jobTypeModel={},b.jobTypeOptions=[{id:"T",label:"Tetto"},{id:"C",label:"Copertura"},{id:"P",label:"Pavimentazione"},{id:"F",label:"Facciata"}],b.jobTypeSettings={closeOnSelect:!0,selectionLimit:1,smartButtonMaxItems:1,smartButtonTextConverter:function(a,b){return b.label}},b.managerModel={},b.managerOptions=[],b.managerSettings={closeOnSelect:!0,selectionLimit:1,smartButtonMaxItems:1,smartButtonTextConverter:function(a,b){return b.label}},b.getHighRiseDeal=function(){if(b.hrtokenIta=g.get("hrtokenIta"),b.hrtokenSwi=g.get("hrtokenSwi"),b.hrdeal=null,b.hrValidationMsg=null,!b.dealurl||-1==b.dealurl.indexOf(o)&&-1==b.dealurl.indexOf(p))b.hrValidationMsg="Il link inserito non è un deal valido";else if(b.hrtokenIta||-1==b.dealurl.indexOf(p))if(b.hrtokenSwi||-1==b.dealurl.indexOf(o)){if(-1!=b.dealurl.indexOf(o)){var a=b.dealurl;-1!=a.indexOf("/edit")&&(a=a.substring(0,a.indexOf("/edit"))),h.get({dealurl:a,token:b.hrtokenSwi},function(c){b.hrdeal=c,i.get({country:"SWI",token:b.hrtokenSwi},function(d){if(b.managerOptions=[],d.users&&d.users.user&&d.users.user.length){var e=d.users.user;e.forEach(function(a){b.managerOptions.push({id:a.id.$t,label:a.name})}),b.managerModel.id=c.data.deal["responsible-party-id"].$t}j.get({dealurl:a,token:b.hrtokenSwi},function(a){console.log("Categories",cat)}),console.log("hrdeals",b.hrdeal),b.hrValidationMsg=null})})}else if(-1!=b.dealurl.indexOf(p)){var a=b.dealurl;-1!=a.indexOf("/edit")&&(a=a.substring(0,a.indexOf("/edit"))),b.hrdeal=h.get({dealurl:a,token:b.hrtokenIta}),console.log("hrdeals",b.hrdeal),b.hrValidationMsg=null}}else b.hrValidationMsg="Non hai inserito il token Highrise per la società svizzera";else b.hrValidationMsg="Non hai inserito il token Highrise per la società italiana"},b.updateHRDeal=function(){if(b.hrdeal){var a,c=b.hrdeal.data.deal.party.name,d=b.hrdeal.data.deal.id.$t;b.managerOptions.length&&b.managerModel.id&&b.managerOptions.forEach(function(c){c.id===b.managerModel.id&&(a=-1==c.label.indexOf(" ")?c.label.toUpperCase().substring(0,3):c.label.toUpperCase().charAt(0)+c.label.toUpperCase().charAt(c.label.indexOf(" ")+1))}),b.updDealName=c+" - Cantiere in "+b.constructionSite+" - "+b.jobDescription+" - "+d+" - "+a+" - "+(b.jobTypeModel&&b.jobTypeModel.id?b.jobTypeModel.id:"T");var e,f;-1!=b.dealurl.indexOf(o)?(e=b.hrtokenSwi,f="SWI"):-1!=b.dealurl.indexOf(p)&&(e=b.hrtokenIta,f="ITA");var g=new h({id:b.hrdeal.data.deal.id.$t,token:e,name:b.updDealName,responsiblePartyId:b.managerModel.id,country:f});g.$update(function(a){console.log("Result",a),b.hrdeal=a}),v(c,d,b.updDealName)}else b.hrValidationMsg="Invalid Link"};var q,r="465342850022-uccefd9aoqoqum18ctcvg9vai1no554a.apps.googleusercontent.com",s="AIzaSyAggTg6GPKQt710bFV4RiUfByLlKR1BGjg",t=["https://www.googleapis.com/auth/drive"],u=[{title:"0-9"},{title:"A"},{title:"B"},{title:"C-CK"},{title:"CL-CZ"},{title:"D"},{title:"E"},{title:"F-G"},{title:"H-I-J-K-L"},{title:"M"},{title:"N-O"},{title:"P-Q"},{title:"R"},{title:"S"},{title:"T"},{title:"U-v-W-Y-Z"}];b.gdriveLoggedin,a.gDriveLogin=function(){e(function(){gapi.client.setApiKey(s),gapi.client.load("drive","v2").then(k)},100)};var v=function(a,c,d){if(a)for(var e=a.toUpperCase().charAt(0),f=0;f<u.length;f++)if(-1!=u[f].title.indexOf(e)){var g=gapi.client.drive.files.list({maxResults:"100",q:"mimeType = 'application/vnd.google-apps.folder' and '"+u[f].folderId+"' in parents"});g.execute(function(a){if(a.items&&a.items.length){for(var e=a.items,g=!1,h=0;h<e.length;h++)if(-1!=e[h].title.indexOf(c)){g=!0;var i={title:d},j=gapi.client.drive.files.patch({fileId:e[h].id,resource:i});j.execute(function(a){console.log("New Title: "+a.title)});break}g||b.copyTemplateFiles(u[f].folderId,d)}},function(a){console.log("Error",a)});break}},w=function(){var a=gapi.client.request({path:"/drive/v2/files",method:"GET",params:{maxResults:"1",q:"title = 'CH - Preventivi Tetti 2015' and mimeType = 'application/vnd.google-apps.folder'"}});a.then(function(a){if(a.result.items[0]){b.basePreventiviFolderId=a.result.items[0].id;var c=gapi.client.request({path:"/drive/v2/files",method:"GET",params:{maxResults:"100",q:"mimeType = 'application/vnd.google-apps.folder' and '"+b.basePreventiviFolderId+"' in parents"}});c.execute(function(a){var b=a.items;if(console.log(a),b&&b.length){for(var c=0;c<b.length;c++)for(var d=0;d<u.length;d++)b[c].title===u[d].title&&(u[d].folderId=b[c].id);console.log("Populate folders",u)}},function(a){console.log("Error",a)})}},function(a){b.$apply(function(){b.gdriveLoggedin=!1});var c=document.getElementById("authorize-button");return c.style.visibility="",c.onclick=m,!1})};b.copyTemplateFiles=function(a,c){var d=gapi.client.request({path:"/drive/v2/files",method:"GET",params:{maxResults:"1",q:"title = '0 TEMPLATE' and mimeType = 'application/vnd.google-apps.folder'"}});d.then(function(d){if(console.log("Resp",d),d.result.items&&d.result.items[0]){var e=d.result.items[0];b.gdriveRoot={title:e.title,fileId:e.id,mimeType:e.mimeType,items:[],destId:a},n(e.id,b.gdriveRoot,a,c)}})};var x=function(a,b,c,d){var f=new Object;f.title=b,f.parents=[{id:a}],f.mimeType="application/vnd.google-apps.folder",gapi.client.drive.files.insert({resource:f}).execute(function(f){return console.log("Folder Created",f),403!=f.code?(console.log("Folder Created",f),n(c,d,f.id)):void e(function(){return x(a,b,c,d)},200)})}}]),angular.module("galimbertiCrmApp").config(["$stateProvider",function(a){a.state("main",{url:"/",templateUrl:"app/main/main.html",controller:"MainCtrl"})}]),angular.module("galimbertiCrmApp").factory("HighRiseDeal",["$resource",function(a){return a("/api/hrdeals/:id",{id:"@_id"},{update:{method:"PUT"}})}]).factory("HighRisePeople",["$resource",function(a){return a("/api/hrpeople",{},{})}]).factory("HighRiseDealCategory",["$resource",function(a){return a("/api/hrdealcategories",{},{})}]),angular.module("galimbertiCrmApp").controller("NavbarCtrl",["$rootScope","$scope","$location","$modal","localStorageService",function(a,b,c,d,e){b.menu=[{title:"Home",link:"/"}],b.isCollapsed=!0,b.isActive=function(a){return a===c.path()},b.authorizeHighRise=function(){a.tokenIta=e.get("hrtokenIta"),a.tokenSwi=e.get("hrtokenSwi"),b.modalInstance=d.open({templateUrl:"components/modal/authorize-highrise-modal.html",scope:b,size:"md"})},b.saveHighriseTokens=function(){e.set("hrtokenIta",this.tokenIta),e.set("hrtokenSwi",this.tokenSwi),b.modalInstance&&b.modalInstance.dismiss()},b.authorizeGDrive=function(){console.log("authorizeGDrive"),b.modalInstance=d.open({templateUrl:"components/modal/authorize-gdrive-modal.html",scope:b,size:"md"})},b.saveGDriveTokens=function(){b.modalInstance&&b.modalInstance.dismiss()},b.authorizeTrello=function(){console.log("authorizeTrello"),b.modalInstance=d.open({templateUrl:"components/modal/authorize-trello-modal.html",scope:b,size:"md"})},b.saveTrelloTokens=function(){b.modalInstance&&b.modalInstance.dismiss()}}]),angular.module("galimbertiCrmApp").run(["$templateCache",function(a){a.put("app/main/main.html",'<div ng-include="\'components/navbar/navbar.html\'"></div><header class=hero-unit id=banner><div class=container><h1>Galimberti CRM</h1><p class=lead>Beta</p><img src=assets/images/607e053b.logo.png alt="I\'m Querior"></div></header><div class=container><section id=loginbuttons ng-hide=gdriveLoggedin><p>Please connect google drive via button Google Drive</p></section><section id=crmform ng-show=gdriveLoggedin><div class=row><div class=col-lg-12><h1 class=page-header>Highrise</h1></div><div class=col-lg-12><form role=form><fieldset class="form-group text-inverse"><label for=hrdeal>Link Highrise</label><input class=form-control id=hrdeal ng-model=dealurl placeholder="Paste link" required></fieldset><div class=col-lg-12><button type=button class="btn btn-block btn-sm btn-warning m-y-lg" ng-disabled=!dealurl ng-click=getHighRiseDeal()>Verifica Link</button></div></form></div></div><br><br><div class=row ng-show=hrValidationMsg><div class=col-lg-12><h4>Validation Result: {{hrValidationMsg}}</h4></div></div><div class=row ng-show=hrdeal.data.deal.name><div class=col-lg-12><form class="m-y-lg text-left"><fieldset class="form-group m-y-md text-inverse"><label>Highrise Deal Name:</label><p>{{hrdeal.data.deal.name}}</p></fieldset><fieldset class="form-group m-y-md text-inverse"><label>Cliente:</label><p>{{hrdeal.data.deal.party.name}}</p></fieldset><fieldset class="form-group m-y-md text-inverse"><label for=constructionSite>Cantiere in</label><input class=form-control id=constructionSite ng-model=constructionSite placeholder="Comune o Comune e via"></fieldset><fieldset class="form-group m-y-md text-inverse"><label for=jobDescription>Descrizione lavoro</label><input class=form-control id=jobDescription ng-model=jobDescription placeholder="Es. Copertura, Pavimentazione in teack, Facciata"></fieldset><fieldset><label for=jobType>Responsabile</label><div style="text-align: left" id=dealManager ng-dropdown-multiselect="" options=managerOptions selected-model=managerModel extra-settings=managerSettings></div></fieldset><fieldset><label for=jobType>Categoria Lavoro</label><div style="text-align: left" id=jobType ng-dropdown-multiselect="" options=jobTypeOptions selected-model=jobTypeModel extra-settings=jobTypeSettings></div></fieldset><br><button type=submit ng-disabled="!(hrdeal.data.deal.name && constructionSite && jobDescription && managerModel.id && jobTypeModel.id)" class="btn btn-block btn-lg btn-success m-y-lg" ng-click=updateHRDeal()>Vai, è tutto giusto !!!</button></form></div></div><br><br><div class=row><div class=col-lg-12><form class="m-y-lg text-left"><fieldset class="form-group m-y-md text-inverse"><label>New Deal Name :</label><label>{{updDealName}}</label></fieldset></form></div></div></section></div><footer class=footer><div class=container><p>GCRM v0.1 | by <a href=https://twitter.com/querior>@querior</a></p></div></footer>'),a.put("components/modal/authorize-gdrive-modal.html",'<div class=modal-header><h4 class="modal-title text-center color1">GDrive Authorization</h4></div><div class=modal-body><form role=form><div class=form-group><label for=gmail>Email</label><input class=form-control id=gmail ng-model=gmail placeholder="User email" type=email></div><div class=form-group><label for=gpassword>Password</label><input class=form-control id=gpassword ng-model=gpassword placeholder=Password type=password></div></form></div><div class=modal-footer><button type=button ng-click=saveHighriseTokens() class="btn-block btn btn-primary">Save</button></div>'),a.put("components/modal/authorize-highrise-modal.html",'<div class=modal-header><h4 class="modal-title text-center color1">Highrise Token</h4></div><div class=modal-body><form role=form><div class=form-group><label for=tokenIta>Token Italia</label><input class=form-control id=tokenIta ng-model=tokenIta placeholder="Highrise token per Galimberti Italia"></div><div class=form-group><label for=tokenSwi>Token Svizzera</label><input class=form-control id=tokenSwi ng-model=tokenSwi placeholder="Highrise token per Galimberti Svizzera"></div></form></div><div class=modal-footer><button type=button ng-click=saveHighriseTokens() class="btn-block btn btn-primary">Save</button></div>'),a.put("components/modal/authorize-trello-modal.html",'<div class=modal-header><h4 class="modal-title text-center color1">Trello Authorization</h4></div><div class=modal-body><form role=form><div class=form-group><label for=tokenIta>Token Italia</label><input class=form-control id=tokenIta ng-model=tokenIta placeholder="Highrise token per Galimberti Italia"></div><div class=form-group><label for=tokenSwi>Token Svizzera</label><input class=form-control id=tokenSwi ng-model=tokenSwi placeholder="Highrise token per Galimberti Svizzera"></div></form></div><div class=modal-footer><button type=button ng-click=saveHighriseTokens() class="btn-block btn btn-primary">Save</button></div>'),a.put("components/modal/modal.html",'<div class=modal-header><button ng-if=modal.dismissable type=button ng-click=$dismiss() class=close>&times;</button><h4 ng-if=modal.title ng-bind=modal.title class=modal-title></h4></div><div class=modal-body><p ng-if=modal.text ng-bind=modal.text></p><div ng-if=modal.html ng-bind-html=modal.html></div></div><div class=modal-footer><button ng-repeat="button in modal.buttons" ng-class=button.classes ng-click=button.click($event) ng-bind=button.text class=btn></button></div>'),a.put("components/navbar/navbar.html",'<div class="navbar navbar-default navbar-static-top" ng-controller=NavbarCtrl><div class=container><div class=navbar-header><button class=navbar-toggle type=button ng-click="isCollapsed = !isCollapsed"><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="/" class=navbar-brand>galimberti-crm</a></div><div collapse=isCollapsed class="navbar-collapse collapse" id=navbar-main><ul class="nav navbar-nav"><li ng-repeat="item in menu" ng-class="{active: isActive(item.link)}"><a ng-href={{item.link}}>{{item.title}}</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a href=# ng-click=authorizeHighRise()>Highrise</a></li><li><a href=# ng-click=authorizeTrello()>Trello</a></li><li><a href=# id=authorize-button ng-click=gDriveLogin()>Google Drive</a></li></ul></div></div></div>')}]);